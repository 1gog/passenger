<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: Passenger::MessageChannel</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />Passenger::MessageChannel</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../files/lib/passenger/message_channel_rb.html">lib/passenger/message_channel.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
Object
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
This class provides convenience methods for:
</p>
<ul>
<li>sending and receiving raw data over an <a href="../IO.html">IO</a> channel.

</li>
<li>sending and receiving messages over an <a href="../IO.html">IO</a> channel.

</li>
<li>file descriptor (<a href="../IO.html">IO</a> object) passing over a Unix
socket.

</li>
</ul>
<p>
All of these methods use exceptions for error reporting.
</p>
<p>
There are two kinds of messages:
</p>
<dl>
<dt> Array messages </dt><dd>These are just a list of strings, and the message itself has a specific
length. The contained strings may not contain NUL characters
(<tt>&#8217;\0&#8216;</tt>). Note that an array message must have at least
one element.

</dd>
<dt> Scalar messages </dt><dd>These are byte strings which may contain arbitrary binary data. Scalar
messages also have a specific length.

</dd>
</dl>
<p>
The protocol is designed to be low overhead, easy to implement and easy to
parse.
</p>
<p>
<a href="MessageChannel.html">MessageChannel</a> is to be wrapped around an
<a href="../IO.html">IO</a> object. For example:
</p>
<pre>
 a, b = IO.pipe
 channel1 = MessageChannel.new(a)
 channel2 = MessageChannel.new(b)

 # Send an array message.
 channel2.write(&quot;hello&quot;, &quot;world !!&quot;)
 channel1.read    # =&gt; [&quot;hello&quot;, &quot;world !!&quot;]

 # Send a scalar message.
 channel2.write_scalar(&quot;some long string which can contain arbitrary binary data&quot;)
 channel1.read_scalar
</pre>
<p>
The life time of a <a href="MessageChannel.html">MessageChannel</a> is
independent from that of the wrapped <a href="../IO.html">IO</a> object. If
a <a href="MessageChannel.html">MessageChannel</a> object is destroyed, the
underlying <a href="../IO.html">IO</a> object is not automatically closed.
Call <a href="MessageChannel.html#M000074">close</a>() if you want to <a
href="MessageChannel.html#M000074">close</a> the underlying <a
href="../IO.html">IO</a> object.
</p>
<p>
Note: Be careful with mixing the sending/receiving of array messages,
scalar messages and <a href="../IO.html">IO</a> objects. If you send a
collection of any of these in a specific order, then the receiving side
must receive them in the exact some order. So suppose you first send a
message, then an <a href="../IO.html">IO</a> object, then a scalar, then
the receiving side must first receive a message, then an <a
href="../IO.html">IO</a> object, then a scalar. If the receiving side does
things in the wrong order then bad things will happen.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000074">close</a></li>
  <li><a href="#M000073">fileno</a></li>
  <li><a href="#M000066">new</a></li>
  <li><a href="#M000067">read</a></li>
  <li><a href="#M000068">read_scalar</a></li>
  <li><a href="#M000071">recv_io</a></li>
  <li><a href="#M000072">send_io</a></li>
  <li><a href="#M000069">write</a></li>
  <li><a href="#M000070">write_scalar</a></li>
  </ul>





  <div class="sectiontitle">Attributes</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>io</td>
    <td class='attr-desc'>
The wrapped <a href="../IO.html">IO</a> object.

</td>
  </tr>
  </table>

<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000066"></a><b>new</b>(io)
  </div>
  <div class="description">
  <p>
Create a <a href="MessageChannel.html#M000066">new</a> <a
href="MessageChannel.html">MessageChannel</a> by wrapping the given <a
href="../IO.html">IO</a> object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000066_source')" id="l_M000066_source">show source</a> ]</p>
  <div id="M000066_source" class="dyn-source">
<pre>
    <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 77</span>
77:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">io</span>)
78:                 <span class="ruby-ivar">@io</span> = <span class="ruby-identifier">io</span>
79:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000074"></a><b>close</b>()
  </div>
  <div class="description">
  <p>
Close the underlying <a href="../IO.html">IO</a> stream. Might raise
SystemCallError or IOError when something goes wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000074_source')" id="l_M000074_source">show source</a> ]</p>
  <div id="M000074_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 210</span>
210:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
211:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">close</span>
212:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000073"></a><b>fileno</b>()
  </div>
  <div class="description">
  <p>
Return the file descriptor of the underlying <a href="../IO.html">IO</a>
object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000073_source')" id="l_M000073_source">show source</a> ]</p>
  <div id="M000073_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 204</span>
204:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">fileno</span>
205:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">fileno</span>
206:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000067"></a><b>read</b>()
  </div>
  <div class="description">
  <p>
Read an array message from the underlying file descriptor. Returns the
array message as an array, or nil when end-of-stream has been reached.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000067_source')" id="l_M000067_source">show source</a> ]</p>
  <div id="M000067_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 87</span>
 87:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read</span>
 88:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
 89:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">HEADER_SIZE</span>
 90:                         <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-constant">HEADER_SIZE</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
 91:                 <span class="ruby-keyword kw">end</span>
 92:                 
 93:                 <span class="ruby-identifier">chunk_size</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'n'</span>)[<span class="ruby-value">0</span>]
 94:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
 95:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">chunk_size</span>
 96:                         <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-identifier">chunk_size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>)
 97:                 <span class="ruby-keyword kw">end</span>
 98:                 
 99:                 <span class="ruby-identifier">message</span> = []
100:                 <span class="ruby-identifier">offset</span> = <span class="ruby-value">0</span>
101:                 <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
102:                 <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">delimiter_pos</span>.<span class="ruby-identifier">nil?</span>
103:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
104:                                 <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;&quot;</span>
105:                         <span class="ruby-keyword kw">else</span>
106:                                 <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">buffer</span>[<span class="ruby-identifier">offset</span> <span class="ruby-operator">..</span> <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>]
107:                         <span class="ruby-keyword kw">end</span>
108:                         <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">delimiter_pos</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
109:                         <span class="ruby-identifier">delimiter_pos</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">index</span>(<span class="ruby-constant">DELIMITER</span>, <span class="ruby-identifier">offset</span>)
110:                 <span class="ruby-keyword kw">end</span>
111:                 <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">message</span>
112:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>
113:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
114:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
115:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
116:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000068"></a><b>read_scalar</b>(max_size = nil)
  </div>
  <div class="description">
  <p>
Read a scalar message from the underlying <a href="../IO.html">IO</a>
object. Returns the <a href="MessageChannel.html#M000067">read</a> message,
or nil on end-of-stream.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
<p>
The <tt>max_size</tt> argument allows one to specify the maximum allowed
size for the scalar message. If the received scalar message&#8216;s size is
larger than <tt>max_size</tt>, then a SecurityError will be raised.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000068_source')" id="l_M000068_source">show source</a> ]</p>
  <div id="M000068_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 127</span>
127:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">read_scalar</span>(<span class="ruby-identifier">max_size</span> = <span class="ruby-keyword kw">nil</span>)
128:                 <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
129:                 <span class="ruby-identifier">temp</span> = <span class="ruby-value str">''</span>
130:                 <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">4</span>
131:                         <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-value">4</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">temp</span>)
132:                 <span class="ruby-keyword kw">end</span>
133:                 <span class="ruby-identifier">size</span> = <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'N'</span>)[<span class="ruby-value">0</span>]
134:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
135:                         <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span>
136:                 <span class="ruby-keyword kw">else</span>
137:                         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">max_size</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">max_size</span>
138:                                 <span class="ruby-identifier">raise</span> <span class="ruby-constant">SecurityError</span>, <span class="ruby-node">&quot;Scalar message size (#{size}) &quot;</span> <span class="ruby-operator">&lt;&lt;</span>
139:                                         <span class="ruby-node">&quot;exceeds maximum allowed size (#{max_size}).&quot;</span>
140:                         <span class="ruby-keyword kw">end</span>
141:                         <span class="ruby-identifier">buffer</span> = <span class="ruby-value str">''</span>
142:                         <span class="ruby-keyword kw">while</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">size</span>
143:                                 <span class="ruby-identifier">buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">readpartial</span>(<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">buffer</span>.<span class="ruby-identifier">size</span>, <span class="ruby-identifier">temp</span>)
144:                         <span class="ruby-keyword kw">end</span>
145:                         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">buffer</span>
146:                 <span class="ruby-keyword kw">end</span>
147:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span>
148:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
149:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
150:                 <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">nil</span>
151:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000071"></a><b>recv_io</b>()
  </div>
  <div class="description">
  <p>
Receive an <a href="../IO.html">IO</a> object (a file descriptor) from the
channel. The other side must have sent an <a href="../IO.html">IO</a>
object by calling <a href="MessageChannel.html#M000072">send_io</a>(). Note
that this only works on Unix sockets.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000071_source')" id="l_M000071_source">show source</a> ]</p>
  <div id="M000071_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 189</span>
189:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">recv_io</span>
190:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">recv_io</span>
191:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000072"></a><b>send_io</b>(io)
  </div>
  <div class="description">
  <p>
Send an <a href="../IO.html">IO</a> object (a file descriptor) over the
channel. The other side must receive the <a href="../IO.html">IO</a> object
by calling <a href="MessageChannel.html#M000071">recv_io</a>(). Note that
this only works on Unix sockets.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000072_source')" id="l_M000072_source">show source</a> ]</p>
  <div id="M000072_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 199</span>
199:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">send_io</span>(<span class="ruby-identifier">io</span>)
200:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">send_io</span>(<span class="ruby-identifier">io</span>)
201:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000069"></a><b>write</b>(name, *args)
  </div>
  <div class="description">
  <p>
Send an array message, which consists of the given elements, over the
underlying file descriptor. <em>name</em> is the first element in the
message, and <em>args</em> are the other elements. These arguments will
internally be converted to strings by calling to_s().
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000069_source')" id="l_M000069_source">show source</a> ]</p>
  <div id="M000069_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 160</span>
160:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write</span>(<span class="ruby-identifier">name</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
161:                 <span class="ruby-identifier">check_argument</span>(<span class="ruby-identifier">name</span>)
162:                 <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
163:                         <span class="ruby-identifier">check_argument</span>(<span class="ruby-identifier">arg</span>)
164:                 <span class="ruby-keyword kw">end</span>
165:                 
166:                 <span class="ruby-identifier">message</span> = <span class="ruby-node">&quot;#{name}#{DELIMITER}&quot;</span>
167:                 <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
168:                         <span class="ruby-identifier">message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DELIMITER</span>
169:                 <span class="ruby-keyword kw">end</span>
170:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">write</span>([<span class="ruby-identifier">message</span>.<span class="ruby-identifier">size</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'n'</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">message</span>)
171:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">flush</span>
172:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000070"></a><b>write_scalar</b>(data)
  </div>
  <div class="description">
  <p>
Send a scalar message over the underlying <a href="../IO.html">IO</a>
object.
</p>
<p>
Might raise SystemCallError, IOError or SocketError when something goes
wrong.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000070_source')" id="l_M000070_source">show source</a> ]</p>
  <div id="M000070_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/message_channel.rb, line 178</span>
178:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">write_scalar</span>(<span class="ruby-identifier">data</span>)
179:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">write</span>([<span class="ruby-identifier">data</span>.<span class="ruby-identifier">size</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'N'</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span>)
180:                 <span class="ruby-ivar">@io</span>.<span class="ruby-identifier">flush</span>
181:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>