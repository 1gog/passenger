<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>Class: Passenger::AbstractRequestHandler</title>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />

    <script language="JavaScript" type="text/javascript">
    // <![CDATA[

        function toggleSource( id )
        {
          var elem
          var link

          if( document.getElementById )
          {
            elem = document.getElementById( id )
            link = document.getElementById( "l_" + id )
          }
          else if ( document.all )
          {
            elem = eval( "document.all." + id )
            link = eval( "document.all.l_" + id )
          }
          else
            return false;

          if( elem.style.display == "block" )
          {
            elem.style.display = "none"
            link.innerHTML = "show source"
          }
          else
          {
            elem.style.display = "block"
            link.innerHTML = "hide source"
          }
        }

        function openCode( url )
        {
          window.open( url, "SOURCE_CODE", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=480,width=750" ).focus();
        }
      // ]]>
    </script>
  </head>

  <body>
  <table width="100%" border='0' cellpadding='0' cellspacing='0' class='banner'><tr>
  <td class="file-title"><span class="file-title-prefix">Class</span><br />Passenger::AbstractRequestHandler</td>
  <td align="right">
    <table cellspacing="0" cellpadding="2">
      <tr valign="top">
        <td>In:</td>
        <td>
<a href="../../files/lib/passenger/abstract_request_handler_rb.html">lib/passenger/abstract_request_handler.rb</a>
        </td>
      </tr>
    <tr>
      <td>Parent:</td>
      <td>
Object
     </td>
   </tr>
         </table>
        </td>
        </tr>
      </table>
 <!-- banner header -->

  <div id="bodyContent">
      <div id="content">

  <div class="description"><p>
The request handler is the layer which connects Apache with the underlying
application&#8216;s request dispatcher (i.e. either Rails&#8216;s
Dispatcher class or Rack). The request handler&#8216;s job is to process
incoming HTTP requests using the currently loaded Ruby on Rails
application. HTTP requests are forwarded to the request handler by the web
server. HTTP responses generated by the RoR application are forwarded to
the web server, which, in turn, sends the response back to the HTTP client.
</p>
<p>
<a href="AbstractRequestHandler.html">AbstractRequestHandler</a> is an
abstract base class for easing the implementation of request handlers for
Rails and Rack.
</p>
<h2>Design decisions</h2>
<p>
Some design decisions are made because we want to decrease system
administrator maintenance overhead. These decisions are documented in this
section.
</p>
<h3>Abstract namespace Unix sockets</h3>
<p>
<a href="AbstractRequestHandler.html">AbstractRequestHandler</a> listens on
a Unix socket for incoming requests. If possible, <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> will try to
create a Unix socket on the _abstract namespace_, instead of on the
filesystem. If the RoR application crashes (segfault), or if it gets killed
by SIGKILL, or if the system loses power, then there will be no stale
socket files left on the filesystem. Unfortunately, abstract namespace Unix
sockets are only supported by Linux. On systems that do not support
abstract namespace Unix sockets, <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> will
automatically fallback to using regular Unix socket files.
</p>
<p>
It is possible to force <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> to use
regular Unix socket files by setting the environment variable
PASSENGER_NO_ABSTRACT_NAMESPACE_SOCKETS to 1.
</p>
<h3>Owner pipes</h3>
<p>
Because only the web server communicates directly with a request handler,
we want the request handler to exit if the web server has also exited. This
is implemented by using a so-called _owner pipe_. The writable part of the
pipe will be owned by the web server. <a
href="AbstractRequestHandler.html">AbstractRequestHandler</a> will
continuously check whether the other side of the pipe has been closed. If
so, then it knows that the web server has exited, and so the request
handler will exit as well. This works even if the web server gets killed by
SIGKILL.
</p>
<h2>Request format</h2>
<p>
Incoming &quot;HTTP requests&quot; are not true HTTP requests, i.e. their
binary representation do not conform to RFC 2616. Instead, the request
format is based on CGI, and is similar to that of SCGI.
</p>
<p>
The format consists of 3 parts:
</p>
<ul>
<li>A 32-bit big-endian integer, containing the size of the transformed
headers.

</li>
<li>The transformed HTTP headers.

</li>
<li>The verbatim (untransformed) HTTP request body.

</li>
</ul>
<p>
HTTP headers are transformed to a format that satisfies the following
grammar:
</p>
<pre>
 headers ::= header*
 header ::= name NUL value NUL
 name ::= notnull+
 value ::= notnull+
 notnull ::= &quot;\x01&quot; | &quot;\x02&quot; | &quot;\x02&quot; | ... | &quot;\xFF&quot;
 NUL = &quot;\x00&quot;
</pre>
<p>
The web server transforms the HTTP request to the aforementioned format,
and sends it to the request handler.
</p>
</div>



  <div class="sectiontitle">Methods</div>
  <ul>
  <li><a href="#M000041">cleanup</a></li>
  <li><a href="#M000043">main_loop</a></li>
  <li><a href="#M000040">new</a></li>
  <li><a href="#M000042">using_abstract_namespace?</a></li>
  </ul>

<div class="sectiontitle">Included Modules</div>
<ul>
  <li><a href="Utils.html">Utils</a></li>
</ul>



  <div class="sectiontitle">Constants</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class="attr-name">HARD_TERMINATION_SIGNAL</td>
    <td>=</td>
    <td class="attr-value">&quot;SIGTERM&quot;</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
Signal which will cause the Rails application to exit immediately.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">SOFT_TERMINATION_SIGNAL</td>
    <td>=</td>
    <td class="attr-value">&quot;SIGUSR1&quot;</td>
  </tr>
  <tr valign='top'>
    <td>&nbsp;</td>
    <td colspan="2" class="attr-desc">
Signal which will cause the Rails application to exit as soon as it&#8216;s
done processing a request.

</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">BACKLOG_SIZE</td>
    <td>=</td>
    <td class="attr-value">50</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">MAX_HEADER_SIZE</td>
    <td>=</td>
    <td class="attr-value">128 * 1024</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">PASSENGER_VERSION</td>
    <td>=</td>
    <td class="attr-value">determine_passenger_version</td>
  </tr>
  <tr valign='top'>
    <td class="attr-name">PASSENGER_HEADER</td>
    <td>=</td>
    <td class="attr-value">determine_passenger_header</td>
  </tr>
  </table>

  <div class="sectiontitle">Attributes</div>
  <table border='0' cellpadding='5'>
  <tr valign='top'>
    <td class='attr-rw'>
[R]
    </td>
    <td class='attr-name'>socket_name</td>
    <td class='attr-desc'>
The name of the socket on which the request handler accepts <a
href="AbstractRequestHandler.html#M000040">new</a> connections. This is
either a Unix socket filename, or the name for an abstract namespace Unix
socket.

<p>
If <tt>socket_name</tt> refers to an abstract namespace Unix socket, then
the name does <em>not</em> contain a leading null byte.
</p>
<p>
See also <a
href="AbstractRequestHandler.html#M000042">using_abstract_namespace?</a>
</p>
</td>
  </tr>
  </table>

<div class="sectiontitle">Public Class methods</div>
<div class="method">
  <div class="title">
    <a name="M000040"></a><b>new</b>(owner_pipe)
  </div>
  <div class="description">
  <p>
Create a <a href="AbstractRequestHandler.html#M000040">new</a>
RequestHandler with the given owner pipe. <tt>owner_pipe</tt> must be the
readable part of a pipe <a href="../IO.html">IO</a> object.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000040_source')" id="l_M000040_source">show source</a> ]</p>
  <div id="M000040_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/abstract_request_handler.rb, line 119</span>
119:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">owner_pipe</span>)
120:                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">abstract_namespace_sockets_allowed?</span>
121:                         <span class="ruby-ivar">@using_abstract_namespace</span> = <span class="ruby-identifier">create_unix_socket_on_abstract_namespace</span>
122:                 <span class="ruby-keyword kw">else</span>
123:                         <span class="ruby-ivar">@using_abstract_namespace</span> = <span class="ruby-keyword kw">false</span>
124:                 <span class="ruby-keyword kw">end</span>
125:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@using_abstract_namespace</span>
126:                         <span class="ruby-identifier">create_unix_socket_on_filesystem</span>
127:                 <span class="ruby-keyword kw">end</span>
128:                 <span class="ruby-ivar">@owner_pipe</span> = <span class="ruby-identifier">owner_pipe</span>
129:                 <span class="ruby-ivar">@previous_signal_handlers</span> = {}
130:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="sectiontitle">Public Instance methods</div>
<div class="method">
  <div class="title">
    <a name="M000041"></a><b>cleanup</b>()
  </div>
  <div class="description">
  <p>
Clean up temporary stuff created by the request handler. This method should
be called after the main loop has exited.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000041_source')" id="l_M000041_source">show source</a> ]</p>
  <div id="M000041_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/abstract_request_handler.rb, line 134</span>
134:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cleanup</span>
135:                 <span class="ruby-ivar">@socket</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
136:                 <span class="ruby-ivar">@owner_pipe</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
137:                 <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">using_abstract_namespace?</span>
138:                         <span class="ruby-constant">File</span>.<span class="ruby-identifier">unlink</span>(<span class="ruby-ivar">@socket_name</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
139:                 <span class="ruby-keyword kw">end</span>
140:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000043"></a><b>main_loop</b>()
  </div>
  <div class="description">
  <p>
Enter the request handler&#8216;s main loop.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000043_source')" id="l_M000043_source">show source</a> ]</p>
  <div id="M000043_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/abstract_request_handler.rb, line 148</span>
148:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">main_loop</span>
149:                 <span class="ruby-identifier">reset_signal_handlers</span>
150:                 <span class="ruby-keyword kw">begin</span>
151:                         <span class="ruby-identifier">done</span> = <span class="ruby-keyword kw">false</span>
152:                         <span class="ruby-keyword kw">while</span> <span class="ruby-operator">!</span><span class="ruby-identifier">done</span>
153:                                 <span class="ruby-identifier">client</span> = <span class="ruby-identifier">accept_connection</span>
154:                                 <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">client</span>.<span class="ruby-identifier">nil?</span>
155:                                         <span class="ruby-keyword kw">break</span>
156:                                 <span class="ruby-keyword kw">end</span>
157:                                 <span class="ruby-identifier">trap</span> <span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span> <span class="ruby-keyword kw">do</span>
158:                                         <span class="ruby-identifier">done</span> = <span class="ruby-keyword kw">true</span>
159:                                 <span class="ruby-keyword kw">end</span>
160:                                 <span class="ruby-keyword kw">begin</span>
161:                                         <span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input</span> = <span class="ruby-identifier">parse_request</span>(<span class="ruby-identifier">client</span>)
162:                                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">headers</span>
163:                                                 <span class="ruby-identifier">process_request</span>(<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">input</span>, <span class="ruby-identifier">client</span>)
164:                                         <span class="ruby-keyword kw">end</span>
165:                                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">IOError</span>, <span class="ruby-constant">SocketError</span>, <span class="ruby-constant">SystemCallError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
166:                                         <span class="ruby-identifier">print_exception</span>(<span class="ruby-value str">&quot;Passenger RequestHandler&quot;</span>, <span class="ruby-identifier">e</span>)
167:                                 <span class="ruby-keyword kw">ensure</span>
168:                                         <span class="ruby-identifier">client</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
169:                                 <span class="ruby-keyword kw">end</span>
170:                                 <span class="ruby-identifier">trap</span> <span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>, <span class="ruby-constant">DEFAULT</span>
171:                         <span class="ruby-keyword kw">end</span>
172:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">EOFError</span>
173:                         <span class="ruby-comment cmt"># Exit main loop.</span>
174:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Interrupt</span>
175:                         <span class="ruby-comment cmt"># Exit main loop.</span>
176:                 <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">signal</span>
177:                         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">HARD_TERMINATION_SIGNAL</span> <span class="ruby-operator">&amp;&amp;</span>
178:                            <span class="ruby-identifier">signal</span>.<span class="ruby-identifier">message</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">SOFT_TERMINATION_SIGNAL</span>
179:                                 <span class="ruby-identifier">raise</span>
180:                         <span class="ruby-keyword kw">end</span>
181:                 <span class="ruby-keyword kw">ensure</span>
182:                         <span class="ruby-identifier">revert_signal_handlers</span>
183:                 <span class="ruby-keyword kw">end</span>
184:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
<div class="method">
  <div class="title">
    <a name="M000042"></a><b>using_abstract_namespace?</b>()
  </div>
  <div class="description">
  <p>
Returns whether socket_name refers to an abstract namespace Unix socket.
</p>
  </div>
<div class="sourcecode">
  <p class="source-link">[ <a href="javascript:toggleSource('M000042_source')" id="l_M000042_source">show source</a> ]</p>
  <div id="M000042_source" class="dyn-source">
<pre>
     <span class="ruby-comment cmt"># File lib/passenger/abstract_request_handler.rb, line 143</span>
143:         <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">using_abstract_namespace?</span>
144:                 <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@using_abstract_namespace</span>
145:         <span class="ruby-keyword kw">end</span>
</pre>
  </div>
</div>
</div>
</div>

  </div>

    </body>
</html>